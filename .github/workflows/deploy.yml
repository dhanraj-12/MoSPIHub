name: CD for MoSPI

on:
  workflow_run:
    workflows: [CI for MoSPI]
    types: 
     - completed

jobs:
    deploy:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }} 


        steps:
            - name: checkout code
              uses: actions/checkout@v3

            - name: Set up SSH key
              run: |
                  echo "${{ secrets.EC2_KEY }}" > ec2_key.pem
                  chmod 600 ec2_key.pem
            
            - name: Deploy to Ec2
              run: |
                ssh -i ec2_key.pem -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} "
                  
                  # setting repo detail
                  REPO_DIR=/home/ubuntu/MoSPIHub
                  REPO_URL=https://github.com/dhanraj-12/MoSPIHub

                  #  Clone or pull repo
                  if [ -d \"\$REPO_DIR/.git\" ]; then
                    echo 'Repo exists, pulling latest changes...'
                    cd \$REPO_DIR
                    git reset --hard
                    git pull origin main
                  else
                    echo 'Repo does not exist, cloning...'
                    git clone \$REPO_URL 
                  fi

                  #creating .env

                  cat > \$REPO_DIR/backend/.env << EOF
                  PORT=${{secrets.PORT}}
                  DB_USER=${{secrets.DB_USER}}
                  DB_HOST=${{secrets.DB_HOST}}
                  DATABASE=${{secrets.DATABASE}}
                  DB_PASSWORD=${{secrets.DB_PASSWORD}}
                  RDSPORT=${{secrets.RDSPORT}}
                  MONGO_URI=${{secrets.MONGO_URI}}
                  EOF


                  #build backend

                  cd \&REPO_DIR/backend
                  npm ci
                  npm run build

                  #build and deploy frontend
                  cd ../frontend
                  npm run build
                  rm -rf /var/www/html/*
                  cp -r build/* /var/www/html


                  #cd ../backend
                  pm2 restart all || pm2 start dist/index.js --name mospihub-backend
                "

            
    


